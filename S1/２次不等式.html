<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2æ¬¡ä¸ç­‰å¼ã®ã‚¯ã‚¤ã‚º</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
        }

        #problem {
            word-wrap: break-word;
            /* å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶å‘ã‘ */
            overflow-wrap: break-word;
            /* æœ€æ–°ã®ãƒ–ãƒ©ã‚¦ã‚¶å‘ã‘ */
            white-space: normal;
            /* æ”¹è¡Œã‚’æœ‰åŠ¹åŒ– */
        }

        #problem,
        #solution,
        #timer {
            font-size: 24px;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }

        #options {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }

        #start-screen {
            display: block;
        }

        #quiz-screen,
        #end-screen {
            display: none;
        }

        .paint-button {
            display: inline-block;
            margin: 20px 0;
            font-size: 9px;
            padding: 10px 20px;
            width: 80px;
            height: 40px;
            background-color: #aaadaf;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            text-align: center;
        }

        .paint-button:hover {
            background-color: #3c3d3e;
        }

        button.active {
            background-color: #007bff;
            /* é¸æŠä¸­ãƒœã‚¿ãƒ³ã®è‰²ï¼ˆé’ï¼‰ */
            color: white;
            border: 2px solid #0056b3;
            transform: scale(1.05);
        }

        #drawingCanvas {
            /* è¨ˆç®—ã‚¹ãƒšãƒ¼ã‚¹ã®å¢ƒç•Œç·šã‚’å¾“æ¥é€šã‚Šè¡¨ç¤º */
            border: 1px solid black;
        }

        #problem table {
            /* è¡¨å…¨ä½“ã‚’ä¸­å¤®ã«é…ç½® */
            margin-left: auto;
            margin-right: auto;
            /* ã‚»ãƒ«ã®æ ç·šã‚’åˆ†é›¢ã—ã¦ã€è¦‹ã‚„ã™ã„ã‚ˆã†ã«ã™ã‚‹ */
            border-collapse: collapse;
        }

        #problem table,
        #problem th,
        #problem td {
            /* è¡¨ã®ç·šï¼ˆç½«ç·šï¼‰ã‚’è¿½åŠ  */
            border: 1px solid #333;
            /* æ¿ƒã„ç°è‰²ã®1pxã®å®Ÿç·š */
            /* ã‚»ãƒ«å†…ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆä½™ç™½ï¼‰ã‚’è¨­å®š */
            padding: 8px 15px;
        }

        #problem th {
            /* è¦‹å‡ºã—ã‚»ãƒ«ã®èƒŒæ™¯è‰²ã‚’è¨­å®šï¼ˆä»»æ„ï¼‰ */
            background-color: #f0f0f0;
        }

        .mathjax-x-label {
            position: absolute;
            /* Canvasã‚³ãƒ³ãƒ†ãƒŠå†…ã§çµ¶å¯¾ä½ç½®æŒ‡å®š */
            top: 0;
            /* ä»®ã®å€¤ã€‚JSã§è¨­å®šã—ç›´ã™ */
            left: 0;
            /* ä»®ã®å€¤ã€‚JSã§è¨­å®šã—ç›´ã™ */
            font-size: 20px;
            /* ãƒ©ãƒ™ãƒ«ã®ã‚µã‚¤ã‚º */
        }

        /* --- â†‘ã“ã“ã¾ã§è¿½åŠ ãƒ»ä¿®æ­£ã™ã‚‹CSS --- */
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS_HTML"></script>
</head>

<body>
    <div id="start-screen">
        <h1>2æ¬¡ä¸ç­‰å¼ã®ã‚¯ã‚¤ã‚º</h1>
        <h2>3å•é€£ç¶šã§æ­£è§£ã—ã¾ã—ã‚‡ã†ï¼</h2>
        <h2>ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
        <button onclick="startQuiz(1)">ãƒ¬ãƒ™ãƒ«1(å› æ•°åˆ†è§£)</button>
        <button onclick="startQuiz(2)">ãƒ¬ãƒ™ãƒ«2(ãŸã™ãæ›ã‘)</button>
        <button onclick="startQuiz(3)">ãƒ¬ãƒ™ãƒ«3(è§£ã®å…¬å¼)</button>
        <button onclick="startQuiz(4)">ãƒ¬ãƒ™ãƒ«4(è§£ã®å…¬å¼ï¼šç´„åˆ†ã‚ã‚Š)</button>
        <button onclick="startQuiz(5)">ãƒ¬ãƒ™ãƒ«5(è§£ã®å…¬å¼ï¼šè¤‡é›‘)</button>
        <button onclick="startQuiz(6)">ãƒ¬ãƒ™ãƒ«6(è§£ã®å…¬å¼ï¼šãƒ©ãƒ³ãƒ€ãƒ )</button>
    </div>

    <div id="quiz-screen">
        <div id="Level">ãƒ¬ãƒ™ãƒ«<span id="selectedLevel">0</span></div>
        <div id="timer">çµŒéæ™‚é–“: <span id="time">0</span>ç§’ é€£ç¶šæ­£è§£æ•°: <span id="currentC">0</span></div>
        <div id="problem">ã“ã“ã«å•é¡ŒãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        <div id="options"></div>
        <div id="solution"></div>
        <h2>è¨ˆç®—ã‚¹ãƒšãƒ¼ã‚¹</h2>
        <div class="controls">
            <button id="clearBtn" class="paint-button">ã‚¯ãƒªã‚¢</button>
            <button id="eraserBtn" class="paint-button">æ¶ˆã—ã‚´ãƒ </button>
            <button id="penBtn" class="paint-button">ãƒšãƒ³</button>
            <label>
                ç·šã®è‰²:
                <input type="color" id="colorPicker" value="#000000">
            </label>
        </div>
        <canvas id="drawingCanvas" width="800" height="600"></canvas>
    </div>

    <div id="end-screen">
        <h1>çµ‚äº†ç”»é¢</h1>
        <p>ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ãƒ¬ãƒ™ãƒ«<span id="clearedLevel">0</span>ã‚¯ãƒªã‚¢ï¼</p>
        <p>3å•æ­£è§£ã™ã‚‹ã¾ã§ã«ã‹ã‹ã£ãŸæ™‚é–“: <span id="elapsedTime"></span>ç§’</p>

        <h2>ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
        <button onclick="resetQuiz(1)">ãƒ¬ãƒ™ãƒ«1(å› æ•°åˆ†è§£)</button>
        <button onclick="resetQuiz(2)">ãƒ¬ãƒ™ãƒ«2(ãŸã™ãæ›ã‘)</button>
        <button onclick="resetQuiz(3)">ãƒ¬ãƒ™ãƒ«3(è§£ã®å…¬å¼)</button>
        <button onclick="resetQuiz(4)">ãƒ¬ãƒ™ãƒ«4(è§£ã®å…¬å¼ï¼šç´„åˆ†ã‚ã‚Š)</button>
        <button onclick="resetQuiz(5)">ãƒ¬ãƒ™ãƒ«5(è§£ã®å…¬å¼ï¼šè¤‡é›‘)</button>
        <button onclick="resetQuiz(6)">ãƒ¬ãƒ™ãƒ«6(è§£ã®å…¬å¼ï¼šãƒ©ãƒ³ãƒ€ãƒ )</button>
    </div>
    <script src="math.js"></script>
    <script src="paint.js"></script>
    <script>

        const A = 1;
        const B = 0;
        const C = -4;

        const GRAPH_WIDTH = 400;
        const GRAPH_HEIGHT = 200;
        const GRAPH_CENTER_X = GRAPH_WIDTH / 2;
        const GRAPH_SCALE = 20;
        const GRAPH_CENTER_Y = 110; // xè»¸ã®ä½ç½®
        const AXIS_COLOR = '#888';
        const HIGHLIGHT_BLUE = '#007BFF';
        const SUBTLE_COLOR = AXIS_COLOR;

        function drawAxes(ctx, width, height, centerX, centerY, scale) {
            ctx.beginPath();
            ctx.strokeStyle = AXIS_COLOR;

            const axisStart = centerX - 4 * scale;
            const axisEnd = centerX + 4 * scale;

            ctx.moveTo(axisStart, centerY);
            ctx.lineTo(axisEnd, centerY);
            ctx.stroke();

            ctx.fillStyle = 'black';
            ctx.font = '20px Arial';
        }
        function drawParabola(ctx, width, height, centerX, centerY, scale, colorFlag) {
            const colorAboveX = (colorFlag === 1) ? HIGHLIGHT_BLUE : SUBTLE_COLOR;
            const colorBelowX = (colorFlag === 2) ? HIGHLIGHT_BLUE : SUBTLE_COLOR;
            ctx.lineWidth = 2;

            const startI = centerX - 5 * scale;
            const endI = centerX + 5 * scale;

            for (let i = startI; i <= endI; i++) {
                const x = (i - centerX) / scale;
                const y = A * x * x + B * x + C;
                const canvasY = centerY - y * scale;

                let currentStrokeStyle;
                if (y > 0) {
                    currentStrokeStyle = colorAboveX;
                } else {
                    currentStrokeStyle = colorBelowX;
                }

                if (i === startI) {
                    ctx.beginPath();
                    ctx.strokeStyle = currentStrokeStyle;
                    ctx.moveTo(i, canvasY);
                } else {
                    const prevX = ((i - 1) - centerX) / scale;
                    const prevY = A * prevX * prevX + B * prevX + C;

                    if ((y > 0 && prevY <= 0) || (y < 0 && prevY >= 0)) {

                        const t = -prevY / (y - prevY);
                        const boundaryX = (i - 1) + t;

                        ctx.lineTo(boundaryX, centerY);
                        ctx.stroke();

                        ctx.beginPath();
                        ctx.strokeStyle = currentStrokeStyle;
                        ctx.moveTo(boundaryX, centerY);
                    }

                    ctx.lineTo(i, canvasY);
                }
            }
            ctx.stroke();
        }
        function createMathJaxLabel(xposition, xValue, centerX, centerY, scale) {
            const canvasX = centerX + xposition * scale;
            const canvasY = centerY;
            const labelDiv = document.createElement('div');
            labelDiv.className = 'mathjax-x-label';
            labelDiv.innerHTML = `\\(${xValue}\\)`;
            labelDiv.style.position = 'absolute';
            labelDiv.style.top = `${canvasY + 5}px`;
            labelDiv.style.transform = 'translateX(-50%)';
            labelDiv.style.left = `${canvasX}px`;
            return labelDiv;
        }


        function drawIntersections(x1, x2, colorFlag) {
            const canvas = document.getElementById('parabolaCanvas');
            const labelContainer = document.getElementById('labelContainer');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            const width = GRAPH_WIDTH;
            const height = GRAPH_HEIGHT;
            const centerX = GRAPH_CENTER_X;
            const scale = GRAPH_SCALE;
            const centerY = GRAPH_CENTER_Y;

            // Canvasã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã€è»¸ã¨æ”¾ç‰©ç·šã‚’æç”»
            ctx.clearRect(0, 0, width, height);
            drawAxes(ctx, width, height, centerX, centerY, scale);
            drawParabola(ctx, width, height, centerX, centerY, scale, colorFlag);

            // ğŸ’¡æ–°è¦: æ—¢å­˜ã®HTMLãƒ©ãƒ™ãƒ«ã‚’ã‚¯ãƒªã‚¢
            if (labelContainer) {
                labelContainer.innerHTML = '';
            }

            let pointsText = "";

            if (x1 !== null && x2 !== null) {
                const points = [x1, x2].sort((a, b) => a - b);
                const leftValue = points[0];
                const rightValue = points[1];

                // ğŸ’¡ä¿®æ­£ç‚¹: Canvasæç”»ã®ä»£ã‚ã‚Šã«DOMè¦ç´ ã‚’ç”Ÿæˆã—ã¦è¿½åŠ 
                if (labelContainer) {
                    // å·¦å´ã®ãƒ©ãƒ™ãƒ«
                    const leftLabel = createMathJaxLabel(-3, leftValue, centerX, centerY, scale);
                    labelContainer.appendChild(leftLabel);

                    // å³å´ã®ãƒ©ãƒ™ãƒ«
                    const rightLabel = createMathJaxLabel(3.2, rightValue, centerX, centerY, scale);
                    labelContainer.appendChild(rightLabel);
                }


            }

            const pointsDiv = document.getElementById('intersectionPoints');
            if (pointsDiv) {
                pointsDiv.innerHTML = pointsText;
            }
        }
        // åˆæœŸè¨­å®šã§ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’å¤‰æ›´
        resizeCanvas();

        // ç”»é¢ãƒªã‚µã‚¤ã‚ºæ™‚ã«ã‚‚ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’èª¿æ•´
        window.addEventListener("resize", resizeCanvas);


        let currentSolution = '';
        let correctCount = 0;
        let timeLeft = 0;
        let timerInterval;
        let shuffleProblem = 0;
        let midwayceremony = '';
        let selectedLevel = 1;  // è¿½åŠ ï¼šé¸æŠã•ã‚ŒãŸãƒ¬ãƒ™ãƒ«ã‚’ä¿å­˜

        let problemContext = {};


        function startQuiz(level) {
            selectedLevel = level;  // è¿½åŠ ï¼šãƒ¬ãƒ™ãƒ«ã‚’ä¿å­˜
            document.getElementById("selectedLevel").innerText = selectedLevel;
            document.getElementById("start-screen").style.display = "none";
            document.getElementById("quiz-screen").style.display = "block";
            nextProblem();
            startTimer();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft++;
                document.getElementById("time").innerText = timeLeft;
                document.getElementById("currentC").innerText = correctCount;
            }, 1000);
        }

        function nextProblem() {
            if (selectedLevel === 1) {
                generateProblem1();
            } else if (selectedLevel === 2) {
                generateProblem2();
            } else if (selectedLevel === 3) {
                generateProblem3();
            } else if (selectedLevel === 4) {
                generateProblem4();
            } else if (selectedLevel === 5) {
                generateProblem5();
            } else if (selectedLevel === 6) {
                generateProblem6();
            }
        }

        function generateProblem1() {
            generateProblem();
            function generateProblem() {
                let frag = getRandomInt(1, 4);
                // ...existing code...
                let a, b;
                do {
                    a = getRandomInt(-8, 8);
                    b = getRandomInt(-8, 8);
                } while (a == b);

                // a ãŒ 0 ã®ã¨ãã¯å¤§å°é–¢ä¿‚ã‚’è¦‹ãšã«ãã®ã¾ã¾ a = 0 ã«ã™ã‚‹
                // ãã‚Œä»¥å¤–ã¯ a > b ã®ã¨ãã«å…¥ã‚Œæ›¿ãˆã¦ a <= b ã«æƒãˆã‚‹ï¼ˆa == b ã®ã¨ãã¯ãã®ã¾ã¾ï¼‰
                if (a !== 0) {
                    if (a > b) {
                        [a, b] = [b, a];
                    }
                }
                // ğŸ’¡ã‚°ãƒ©ãƒ•æç”»ç”¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¿å­˜
                problemContext.x1 = a;
                problemContext.x2 = b;
                let result;
                if (frag == 1) {
                    // ä¸ç­‰å¼ãŒ < ã®ã¨ãã€è§£ã¯ x<a,b<x ã®å½¢
                    result = `${a} < x < ${b}`;
                } else if (frag == 2) {
                    // ä¸ç­‰å¼ãŒ <= ã®ã¨ãã€è§£ã¯ x<=a,b<=x ã®å½¢
                    result = `${a} \\leqq x \\leqq ${b}`;
                } else if (frag == 3) {
                    // ä¸ç­‰å¼ãŒ > ã®ã¨ãã€è§£ã¯ a<x<b ã®å½¢
                    result = `x < ${a} , ${b} < x`;
                } else if (frag == 4) {
                    // ä¸ç­‰å¼ãŒ >= ã®ã¨ãã€è§£ã¯ a<=x<=b ã®å½¢
                    result = `x \\leqq ${a} , ${b} \\leqq x`;
                }

                // å› æ•°åˆ†è§£è¡¨ç¤ºï¼š
                // - é‡è§£ (a === b) ã®ã¨ãã¯ (x - a)^2 ã®å½¢ã§è¡¨ç¤ºï¼ˆa=0 ã®ã¨ãã¯ x^2 ã¨è¡¨ç¤ºï¼‰
                // - ãã‚Œä»¥å¤–ã¯é€šå¸¸ã® (x - a)(x - b) è¡¨ç¤ºã€‚ãŸã ã— a===0 ã®ã¨ãã¯ x(x-b) ã®å½¢ã«ã™ã‚‹
                let factorStr;
                const factA = (a > 0) ? `-${a}` : (a < 0 ? `+${Math.abs(a)}` : '');
                const factB = (b > 0) ? `-${b}` : (b < 0 ? `+${Math.abs(b)}` : '');
                if (a === 0 && b === 0) {
                    // a=0, b=0 ã®å ´åˆ: x^2
                    factorStr = 'x^2';
                } else if (a === 0) {
                    // a=0, bâ‰ 0 ã®å ´åˆ: x(x-b)
                    factorStr = `x(x ${factB})`;
                } else if (b === 0) {
                    // bâ‰ 0, a=0 ã®å ´åˆ: x(x-a)
                    factorStr = `x(x ${factA})`;
                } else {
                    // aâ‰ 0, bâ‰ 0 ã®é€šå¸¸ã®å› æ•°åˆ†è§£: (x-a)(x-b)
                    factorStr = `(x ${factA})(x ${factB})`;
                }
                let fragsignal = ``;
                if (frag == 1) {
                    fragsignal = `<`;
                    problemContext.colorFlag = 2; // frag 1 (<) -> y < 0 -> FLAG 2 (ä¸‹å´ã‚’å¼·èª¿)
                }
                else if (frag == 2) {
                    fragsignal = `\\leqq`;
                    problemContext.colorFlag = 2; // frag 2 (<=) -> y <= 0 -> FLAG 2 (ä¸‹å´ã‚’å¼·èª¿)
                }
                else if (frag == 3) {
                    fragsignal = `>`;
                    problemContext.colorFlag = 1; // frag 3 (>) -> y > 0 -> FLAG 1 (ä¸Šå´ã‚’å¼·èª¿)
                }
                else if (frag == 4) {
                    fragsignal = `\\geqq`;
                    problemContext.colorFlag = 1; // frag 4 (>=) -> y >= 0 -> FLAG 1 (ä¸Šå´ã‚’å¼·èª¿)
                }
                midwayceremony = `å› æ•°åˆ†è§£ã™ã‚‹ã¨
                $$${factorStr}${fragsignal}0$$
                <div id="graphPlaceholder"></div>`;
                const answer = `${result}`; // ğŸ’¡ã‚¨ãƒ©ãƒ¼å¯¾ç­–: ã“ã“ã§ answer ã‚’å®šç¾©
                // xé …ã®ä¿‚æ•°ãŒ 1 ã¾ãŸã¯ -1 ã®ã¨ãã¯ "1x" ã¨è¡¨ç¤ºã›ãš "x" ã¨ã™ã‚‹
                const sum = -(a + b);
                const prod = a * b;

                let xTerm = '';
                // xé …ã®ä¿‚æ•°ãŒ 0 ã®ã¨ãã¯è¡¨ç¤ºã—ãªã„ã€‚ä¿‚æ•°ãŒ Â±1 ã®ã¨ãã¯ "1" ã‚’è¡¨ç¤ºã›ãš "x" ã¨ã™ã‚‹ã€‚
                if (sum !== 0) {
                    const absSum = Math.abs(sum);
                    const sign = sum > 0 ? '+' : '-';
                    const coeff = absSum === 1 ? '' : String(absSum);
                    xTerm = `${sign}${coeff}x`;
                }

                // prod ãŒ 0 ã®ã¨ãã¯é …ã‚’è¡¨ç¤ºã—ãªã„ï¼ˆ"+0" ã‚’å‡ºã•ãªã„)
                const cTerm = (prod === 0) ? '' : (prod < 0 ? '-' + Math.abs(prod) : '+' + prod);

                const question = `\\( x^2${xTerm}${cTerm}${fragsignal}0 \\)`;

                currentSolution = answer;
                const options = generateOptions(currentSolution);

                document.getElementById('problem').innerHTML = question;
                document.getElementById('solution').innerHTML = '';

                // ãƒœã‚¿ãƒ³ã¯ DOM è¦ç´ ã§ä½œã‚Šã€ã‚¯ãƒªãƒƒã‚¯æ™‚ã« checkAnswer ã‚’å‘¼ã¶ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å•é¡Œå›é¿ï¼‰
                const optionsContainer = document.getElementById('options');
                optionsContainer.innerHTML = '';
                options.forEach((option, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'option';
                    btn.innerHTML = `${index + 1}: $$${option}$$`; // MathJax è¡¨ç¤ºã‚’æƒ³å®š
                    btn.addEventListener('click', () => {
                        // checkAnswer(option, currentSolution, explanation) ã‚’ä½¿ãˆã°
                        // checkAnswer å´ã§èª¬æ˜ã‚’è¡¨ç¤ºã™ã‚‹ä»•çµ„ã¿ã«ãªã£ã¦ã„ã‚‹æƒ³å®š
                        checkAnswer(option, currentSolution, midwayceremony);
                    });
                    optionsContainer.appendChild(btn);
                });

                MathJax.Hub.Queue(['Typeset', MathJax.Hub]);


            }
            function generateOptions(correct) {
                const options = [correct];

                // è§£ã‚’æ­£è¦åŒ–ã™ã‚‹é–¢æ•°ï¼ˆé †ç•ªã«é–¢ã‚ã‚‰ãšåŒã˜å½¢ã«ã™ã‚‹ï¼‰
                function normalizeValue(value) {
                    // "x=a,b" ã¾ãŸã¯ "x=a" ã®å½¢ã‚’æƒ³å®š
                    const match = value.match(/x=(.+)/);
                    if (!match) return value;

                    const solutions = match[1].split(',').map(s => s.trim());
                    if (solutions.length === 1) {
                        return `x=${solutions[0]}`;
                    }
                    // 2ã¤ã®è§£ã‚’ã‚½ãƒ¼ãƒˆã—ã¦ä¸¦ã¹ç›´ã™
                    solutions.sort((a, b) => parseInt(a) - parseInt(b));
                    return `x=${solutions.join(',')}`;
                }

                while (options.length < 4) {
                    // æ•´æ•°ã®ç¯„å›²ã§ä¹±æ•°ã‚’ç”Ÿæˆ
                    let a, b;
                    do {
                        a = getRandomInt(-8, 8);
                        b = getRandomInt(-8, 8);
                    } while (a === b);
                    if (a > b) {
                        [a, b] = [b, a];
                    }
                    let c = getRandomInt(1, 4);
                    // 0ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯0ã‚’å·¦ã«ã€ãã†ã§ãªã‘ã‚Œã°å°ã•ã„æ–¹ã‚’å·¦ã«
                    let value;
                    if (c == 1) {
                        value = `${a} < x < ${b}`;
                    } else if (c == 2) {
                        value = `x \\leqq ${a} , ${b} \\leqq x`;
                    } else if (c == 3) {
                        value = `x < ${a} , ${b} < x`;
                    } else if (c == 4) {
                        value = `x \\leqq ${a} , ${b} \\leqq x`;
                    }

                    // æ­£è¦åŒ–ã—ã¦ã‹ã‚‰é‡è¤‡ãƒã‚§ãƒƒã‚¯
                    const normalizedValue = normalizeValue(value);
                    if (!options.map(normalizeValue).includes(normalizedValue)) {
                        options.push(value);
                    }
                }

                return shuffleArray(options);
            }
        }


        function generateProblem2() {
            generateProblem();
            function generateProblem() {
                let frag = getRandomInt(1, 4);
                // ...existing code...
                let a, b, c, d;
                do {
                    do {
                        a = getRandomInt(-8, 8);
                        c = getRandomInt(1, 3);
                    } while (gcd(a, c) != 1);
                    do {
                        b = getRandomInt(-8, 8);
                        d = getRandomInt(1, 3);
                    } while (gcd(b, d) != 1);
                } while (a * d - b * c == 0 || (c == 1 && d == 1));
                // a ãŒ 0 ã®ã¨ãã¯å¤§å°é–¢ä¿‚ã‚’è¦‹ãšã«ãã®ã¾ã¾ a = 0 ã«ã™ã‚‹
                if (a * d > b * c) {
                    [a, b, c, d] = [b, a, d, c];
                }

                // ğŸ’¡ã‚°ãƒ©ãƒ•æç”»ç”¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¿å­˜
                if (c == 1) {
                    problemContext.x1 = a;
                }
                else {
                    problemContext.x1 = `${printfrac([a, 1, c, 1])}`;
                }
                if (d == 1) {
                    problemContext.x2 = b;
                }
                else {
                    problemContext.x2 = `${printfrac([b, 1, d, 1])}`;
                }
                let result;
                if (frag == 1) {
                    // ä¸ç­‰å¼ãŒ < ã®ã¨ãã€è§£ã¯ x<a,b<x ã®å½¢
                    result = `${printfrac([a, 1, c, 1])} < x < ${printfrac([b, 1, d, 1])}`;
                } else if (frag == 2) {
                    // ä¸ç­‰å¼ãŒ <= ã®ã¨ãã€è§£ã¯ x<=a,b<=x ã®å½¢
                    result = `${printfrac([a, 1, c, 1])} \\leqq x \\leqq ${printfrac([b, 1, d, 1])}`;
                } else if (frag == 3) {
                    // ä¸ç­‰å¼ãŒ > ã®ã¨ãã€è§£ã¯ a<x<b ã®å½¢
                    result = `x < ${printfrac([a, 1, c, 1])} , ${printfrac([b, 1, d, 1])} < x`;
                } else if (frag == 4) {
                    // ä¸ç­‰å¼ãŒ >= ã®ã¨ãã€è§£ã¯ a<=x<=b ã®å½¢
                    result = `x \\leqq ${printfrac([a, 1, c, 1])} , ${printfrac([b, 1, d, 1])} \\leqq x`;
                }

                // å› æ•°åˆ†è§£è¡¨ç¤ºï¼š
                // - ãã‚Œä»¥å¤–ã¯é€šå¸¸ã® (cx - a)(dx - b) è¡¨ç¤ºã€‚ãŸã ã— a===0 ã®ã¨ãã¯ cx(dx-b) ã®å½¢ã«ã™ã‚‹ã€c==0ã®ã¨ãã¯dx(cx-a) ã®å½¢ã«ã™ã‚‹ã€‚ã¾ãŸã€ c ã¾ãŸã¯ d ãŒ 1 ã®ã¨ãã¯çœç•¥è¡¨ç¤º
                let factorStr;
                if (a === 0) {
                    factorStr = `${c == 1 ? '' : c}x(${d == 1 ? '' : d}x${b < 0 ? '+' + Math.abs(b) : '-' + b})`;
                }
                else if (b === 0) {
                    factorStr = `${d == 1 ? '' : d}x(${c == 1 ? '' : c}x${a < 0 ? '+' + Math.abs(a) : '-' + a})`;
                }
                else {
                    const factorA = `(${c == 1 ? '' : c}x${a < 0 ? '+' + Math.abs(a) : '-' + a})`;
                    const factorB = `(${d == 1 ? '' : d}x${b < 0 ? '+' + Math.abs(b) : '-' + b})`;
                    factorStr = `${factorA}${factorB}`;
                }
                let fragsignal = ``;
                if (frag == 1) {
                    fragsignal = `<`;
                    problemContext.colorFlag = 2; // frag 1 (<) -> y < 0 -> FLAG 2 (ä¸‹å´ã‚’å¼·èª¿)
                }
                else if (frag == 2) {
                    fragsignal = `\\leqq`;
                    problemContext.colorFlag = 2; // frag 2 (<=) -> y <= 0 -> FLAG 2 (ä¸‹å´ã‚’å¼·èª¿)
                }
                else if (frag == 3) {
                    fragsignal = `>`;
                    problemContext.colorFlag = 1; // frag 3 (>) -> y > 0 -> FLAG 1 (ä¸Šå´ã‚’å¼·èª¿)
                }
                else if (frag == 4) {
                    fragsignal = `\\geqq`;
                    problemContext.colorFlag = 1; // frag 4 (>=) -> y >= 0 -> FLAG 1 (ä¸Šå´ã‚’å¼·èª¿)
                }
                midwayceremony = `å› æ•°åˆ†è§£ã™ã‚‹ã¨
                $$${factorStr}${fragsignal}0$$
                <div id="graphPlaceholder"></div>`;
                const answer = `${result}`; // ğŸ’¡ã‚¨ãƒ©ãƒ¼å¯¾ç­–: ã“ã“ã§ answer ã‚’å®šç¾©
                // xé …ã®ä¿‚æ•°ãŒ 1 ã¾ãŸã¯ -1 ã®ã¨ãã¯ "1x" ã¨è¡¨ç¤ºã›ãš "x" ã¨ã™ã‚‹
                const sum = -(a * d + b * c);
                const prod = a * b;
                const proda = c * d;
                let xTerm = '';
                // xé …ã®ä¿‚æ•°ãŒ 0 ã®ã¨ãã¯è¡¨ç¤ºã—ãªã„ã€‚ä¿‚æ•°ãŒ Â±1 ã®ã¨ãã¯ "1" ã‚’è¡¨ç¤ºã›ãš "x" ã¨ã™ã‚‹ã€‚
                if (sum !== 0) {
                    const absSum = Math.abs(sum);
                    const sign = sum > 0 ? '+' : '-';
                    const coeff = absSum === 1 ? '' : String(absSum);
                    xTerm = `${sign}${coeff}x`;
                }

                // prod ãŒ 0 ã®ã¨ãã¯é …ã‚’è¡¨ç¤ºã—ãªã„ï¼ˆ"+0" ã‚’å‡ºã•ãªã„)
                const cTerm = (prod === 0) ? '' : (prod < 0 ? '-' + Math.abs(prod) : '+' + prod);

                const question = `\\( ${proda}x^2${xTerm}${cTerm}${fragsignal}0 \\)`;

                currentSolution = answer;
                const options = generateOptions(currentSolution);

                document.getElementById('problem').innerHTML = question;
                document.getElementById('solution').innerHTML = '';

                // ãƒœã‚¿ãƒ³ã¯ DOM è¦ç´ ã§ä½œã‚Šã€ã‚¯ãƒªãƒƒã‚¯æ™‚ã« checkAnswer ã‚’å‘¼ã¶ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å•é¡Œå›é¿ï¼‰
                const optionsContainer = document.getElementById('options');
                optionsContainer.innerHTML = '';
                options.forEach((option, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'option';
                    btn.innerHTML = `${index + 1}: $$${option}$$`; // MathJax è¡¨ç¤ºã‚’æƒ³å®š
                    btn.addEventListener('click', () => {
                        // checkAnswer(option, currentSolution, explanation) ã‚’ä½¿ãˆã°
                        // checkAnswer å´ã§èª¬æ˜ã‚’è¡¨ç¤ºã™ã‚‹ä»•çµ„ã¿ã«ãªã£ã¦ã„ã‚‹æƒ³å®š
                        checkAnswer(option, currentSolution, midwayceremony);
                    });
                    optionsContainer.appendChild(btn);
                });

                MathJax.Hub.Queue(['Typeset', MathJax.Hub]);


            }
            function generateOptions(correct) {
                const options = [correct];

                // è§£ã‚’æ­£è¦åŒ–ã™ã‚‹é–¢æ•°ï¼ˆé †ç•ªã«é–¢ã‚ã‚‰ãšåŒã˜å½¢ã«ã™ã‚‹ï¼‰
                function normalizeValue(value) {
                    // "x=a,b" ã¾ãŸã¯ "x=a" ã®å½¢ã‚’æƒ³å®š
                    const match = value.match(/x=(.+)/);
                    if (!match) return value;

                    const solutions = match[1].split(',').map(s => s.trim());
                    if (solutions.length === 1) {
                        return `x=${solutions[0]}`;
                    }
                    // 2ã¤ã®è§£ã‚’ã‚½ãƒ¼ãƒˆã—ã¦ä¸¦ã¹ç›´ã™
                    solutions.sort((a, b) => parseInt(a) - parseInt(b));
                    return `x=${solutions.join(',')}`;
                }

                while (options.length < 4) {
                    // æ•´æ•°ã®ç¯„å›²ã§ä¹±æ•°ã‚’ç”Ÿæˆ
                    let a, b, c, d;
                    do {
                        do {
                            a = getRandomInt(-8, 8);
                            c = getRandomInt(1, 3);
                        } while (gcd(a, c) != 1);
                        do {
                            b = getRandomInt(-8, 8);
                            d = getRandomInt(1, 3);
                        } while (gcd(b, d) != 1);
                    } while (a * d - b * c == 0 || (c == 1 && d == 1));
                    if (a * d > b * c) {
                        [a, b, c, d] = [b, a, d, c];
                    }
                    let e = getRandomInt(1, 4);
                    // 0ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯0ã‚’å·¦ã«ã€ãã†ã§ãªã‘ã‚Œã°å°ã•ã„æ–¹ã‚’å·¦ã«
                    let value;
                    if (e == 1) {
                        value = `${printfrac([a, 1, c, 1])} < x < ${printfrac([b, 1, d, 1])}`;
                    } else if (e == 2) {
                        value = `${printfrac([a, 1, c, 1])} \\leqq x \\leqq ${printfrac([b, 1, d, 1])}`;
                    } else if (e == 3) {
                        value = `x < ${printfrac([a, 1, c, 1])} , ${printfrac([b, 1, d, 1])} < x`;
                    } else if (e == 4) {
                        value = `x \\leqq ${printfrac([a, 1, c, 1])} , ${printfrac([b, 1, d, 1])} \\leqq x`;
                    }

                    // æ­£è¦åŒ–ã—ã¦ã‹ã‚‰é‡è¤‡ãƒã‚§ãƒƒã‚¯
                    const normalizedValue = normalizeValue(value);
                    if (!options.map(normalizeValue).includes(normalizedValue)) {
                        options.push(value);
                    }
                }

                return shuffleArray(options);
            }
        }


        function generateProblem3() {
            let frag = [];
            generateProblem();
            function tosolution(numberaa, numberbb, numbercc, f) {
                let numbera = divideBygcb(numberaa, numberbb, numbercc, numberaa);
                let numberb = divideBygcb(numberaa, numberbb, numbercc, numberbb);
                let numberc = divideBygcb(numberaa, numberbb, numbercc, numbercc);
                if (f == 1 || f == 2) {
                    if (numberb % 2 == 0) {
                        let bb = numberb / 2;
                        let rootn = tosqrt(bb * bb - numbera * numberc)[0];
                        if (numbera == 1) {
                            return `${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} ${f == 1 ? '<' : '\\leqq'} x ${f == 1 ? '<' : '\\leqq'} ${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}}`;
                        } else {
                            return `\\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}} ${f == 1 ? '<' : '\\leqq'} x ${f == 1 ? '<' : '\\leqq'} \\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}}`;
                        }
                    }
                    else {
                        let bb = numberb;
                        let rootn = tosqrt(bb * bb - 4 * numbera * numberc)[0];
                        return `\\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}} ${f == 1 ? '<' : '\\leqq'} x ${f == 1 ? '<' : '\\leqq'} \\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}}`;
                    }
                }
                else {
                    if (numberb % 2 == 0) {
                        let bb = numberb / 2;
                        let rootn = tosqrt(bb * bb - numbera * numberc)[0];
                        if (numbera == 1) {
                            return `x ${f == 3 ? '<' : '\\leqq'} ${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} , ${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} ${f == 3 ? '<' : '\\leqq'} x `;
                        } else {
                            return `x ${f == 3 ? '<' : '\\leqq'} \\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}} , \\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}} ${f == 3 ? '<' : '\\leqq'} x `;
                        }
                    }
                    else {
                        let bb = numberb;
                        let rootn = tosqrt(bb * bb - 4 * numbera * numberc)[0];
                        return `x ${f == 3 ? '<' : '\\leqq'} \\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}} , \\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}} ${f == 3 ? '<' : '\\leqq'} x `;
                    }
                }
            }
            function toprblemContet(numberaa, numberbb, numbercc) {
                let numbera = divideBygcb(numberaa, numberbb, numbercc, numberaa);
                let numberb = divideBygcb(numberaa, numberbb, numbercc, numberbb);
                let numberc = divideBygcb(numberaa, numberbb, numbercc, numbercc);

                if (numberb % 2 == 0) {
                    let bb = numberb / 2;
                    let rootn = tosqrt(bb * bb - numbera * numberc)[0];
                    if (numbera == 1) {
                        problemContext.x1 = `${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}}  `;
                        problemContext.x2 = `${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}}  `;
                    } else {
                        problemContext.x1 = `\\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}}  `;
                        problemContext.x2 = `\\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}}  `;
                    }
                }
                else {
                    let bb = numberb;
                    let rootn = tosqrt(bb * bb - 4 * numbera * numberc)[0];
                    problemContext.x1 = `\\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}} `;
                    problemContext.x2 = `\\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}}  `;
                }

            }
            function divideBygcb(a, b, c, d) {
                const lcmValue = gcdOfThree(a, b, c);
                return d / lcmValue;
            }
            function gcdOfThree(a, b, c) {
                // ä¸‰ã¤ã®æ•°ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ã‚‹
                return gcd(gcd(a, b), c);
            }
            function tosqrt(number) {
                let ans = [];
                ans[0] = 1;
                ans[1] = number;
                for (let i = 1; i <= Math.sqrt(ans[1]); i++) {
                    if (ans[1] % (i * i) === 0) {
                        ans[0] = ans[0] * i;
                        ans[1] = ans[1] / (i * i);
                        i = 1;
                    }
                }
                return ans; // å¹³æ–¹æ•°ãŒãªã„å ´åˆ
            }
            function generateProblem() {

                let fraga = getRandomInt(1, 4);
                let a, b, c;
                do {
                    a = 1;
                    b = 2 * getRandomInt(-4, 5) - 1;
                    c = getRandomInt(-8, 8);

                } while (b * b - 4 * a * c < 0 || Math.sqrt(b * b - 4 * a * c) % 1 == 0)
                frag[0] = a;
                frag[1] = b;
                frag[2] = c;

                let fragsignal = ``;
                if (fraga == 1) {
                    fragsignal = `<`;
                    problemContext.colorFlag = 2; // frag 1 (<) -> y < 0 -> FLAG 2 (ä¸‹å´ã‚’å¼·èª¿)
                }
                else if (fraga == 2) {
                    fragsignal = `\\leqq`;
                    problemContext.colorFlag = 2; // frag 2 (<=) -> y <= 0 -> FLAG 2 (ä¸‹å´ã‚’å¼·èª¿)
                }
                else if (fraga == 3) {
                    fragsignal = `>`;
                    problemContext.colorFlag = 1; // frag 3 (>) -> y > 0 -> FLAG 1 (ä¸Šå´ã‚’å¼·èª¿)
                }
                else if (fraga == 4) {
                    fragsignal = `\\geqq`;
                    problemContext.colorFlag = 1; // frag 4 (>=) -> y >= 0 -> FLAG 1 (ä¸Šå´ã‚’å¼·èª¿)
                }
                toprblemContet(a, b, c);

                let question = `\\(${a == 1 ? '' : a}  x^2 ${b === 0 ? '' : (b > 0 ? '+' : '') + (b == 1 ? '' : b == -1 ? '-' : b) + 'x'} ${c === 0 ? '' : (c > 0 ? '+' : '-') + Math.abs(c)}${fragsignal}0\\)`;
                currentSolution = `${tosolution(a, b, c, fraga)}`;
                const result = currentSolution;
                const bAbs = Math.abs(b);
                const cAbs = Math.abs(c);
                const bDisplay = b < 0 ? `(${b})` : b;
                const cDisplay = c < 0 ? `(${c})` : c;
                const FDisplay = 4 * a * c < 0 ? `+${-4 * a * c}` : `-${4 * a * c}`;
                midwayceremony = `$$${a == 1 ? '' : a}  x^2 ${b === 0 ? '' : (b > 0 ? '+' : '') + (b == 1 ? '' : b == -1 ? '-' : b) + 'x'} ${c === 0 ? '' : (c > 0 ? '+' : '-') + Math.abs(c)}=0$$
                ã‚’è§£ã®å…¬å¼ã§è§£ãã¨$$x=\\frac{-${bDisplay}\\pm \\sqrt{${bDisplay}^2 - 4 \\times ${a}\\times ${cDisplay}}}{2\\times ${a}}\\\\ 
                =\\frac{${-b}\\pm \\sqrt{${b * b - 4 * a * c}}}{${2 * a}}$$
                <div id="graphPlaceholder"></div>`;
                const answer = `${result}`;

                currentSolution = answer;
                const options = generateOptions(currentSolution);

                document.getElementById('problem').innerHTML = question;
                document.getElementById('solution').innerHTML = '';

                // ãƒœã‚¿ãƒ³ã¯ DOM è¦ç´ ã§ä½œã‚Šã€ã‚¯ãƒªãƒƒã‚¯æ™‚ã« checkAnswer ã‚’å‘¼ã¶ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å•é¡Œå›é¿ï¼‰
                const optionsContainer = document.getElementById('options');
                optionsContainer.innerHTML = '';
                options.forEach((option, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'option';
                    btn.innerHTML = `${index + 1}: $$${option}$$`; // MathJax è¡¨ç¤ºã‚’æƒ³å®š
                    btn.addEventListener('click', () => {
                        // checkAnswer(option, currentSolution, explanation) ã‚’ä½¿ãˆã°
                        // checkAnswer å´ã§èª¬æ˜ã‚’è¡¨ç¤ºã™ã‚‹ä»•çµ„ã¿ã«ãªã£ã¦ã„ã‚‹æƒ³å®š
                        checkAnswer(option, currentSolution, midwayceremony);
                    });
                    optionsContainer.appendChild(btn);
                });

                MathJax.Hub.Queue(['Typeset', MathJax.Hub]);


            }
            function generateOptions(correct) {
                const options = [correct];

                // è§£ã‚’æ­£è¦åŒ–ã™ã‚‹é–¢æ•°ï¼ˆé †ç•ªã«é–¢ã‚ã‚‰ãšåŒã˜å½¢ã«ã™ã‚‹ï¼‰
                function normalizeValue(value) {
                    // "x=..." ã®å½¢ã‚’æƒ³å®š
                    const match = value.match(/x=(.+)/);
                    if (!match) return value;
                    return `x=${match[1]}`;
                }

                while (options.length < 4) {
                    // æ•´æ•°ã®ç¯„å›²ã§ä¹±æ•°ã‚’ç”Ÿæˆ
                    let a, b, c;
                    let value;
                    let f = getRandomInt(1, 4);
                    do {
                        a = 1;
                        b = 2 * getRandomInt(-4, 5) - 1;
                        c = getRandomInt(-8, 8);
                    } while (b * b - 4 * a * c < 0 || Math.sqrt(b * b - 4 * a * c) % 1 == 0);

                    value = `${tosolution(a, b, c, f)}`;

                    // æ­£è¦åŒ–ã—ã¦ã‹ã‚‰é‡è¤‡ãƒã‚§ãƒƒã‚¯
                    const normalizedValue = normalizeValue(value);
                    if (!options.map(normalizeValue).includes(normalizedValue)) {
                        options.push(value);
                    }
                }

                return shuffleArray(options);
            }
        }


        function generateProblem4() {
            let frag = [];
            generateProblem();
            function tosolution(numberaa, numberbb, numbercc, f) {
                let numbera = divideBygcb(numberaa, numberbb, numbercc, numberaa);
                let numberb = divideBygcb(numberaa, numberbb, numbercc, numberbb);
                let numberc = divideBygcb(numberaa, numberbb, numbercc, numbercc);
                if (f == 1 || f == 2) {
                    if (numberb % 2 == 0) {
                        let bb = numberb / 2;
                        let rootn = tosqrt(bb * bb - numbera * numberc)[0];
                        if (numbera == 1) {
                            return `${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} ${f == 1 ? '<' : '\\leqq'} x ${f == 1 ? '<' : '\\leqq'} ${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}}`;
                        } else {
                            return `\\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}} ${f == 1 ? '<' : '\\leqq'} x ${f == 1 ? '<' : '\\leqq'} \\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}}`;
                        }
                    }
                    else {
                        let bb = numberb;
                        let rootn = tosqrt(bb * bb - 4 * numbera * numberc)[0];
                        return `\\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}} ${f == 1 ? '<' : '\\leqq'} x ${f == 1 ? '<' : '\\leqq'} \\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}}`;
                    }
                }
                else {
                    if (numberb % 2 == 0) {
                        let bb = numberb / 2;
                        let rootn = tosqrt(bb * bb - numbera * numberc)[0];
                        if (numbera == 1) {
                            return `x ${f == 3 ? '<' : '\\leqq'} ${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} , ${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} ${f == 3 ? '<' : '\\leqq'} x `;
                        } else {
                            return `x ${f == 3 ? '<' : '\\leqq'} \\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}} , \\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}} ${f == 3 ? '<' : '\\leqq'} x `;
                        }
                    }
                    else {
                        let bb = numberb;
                        let rootn = tosqrt(bb * bb - 4 * numbera * numberc)[0];
                        return `x ${f == 3 ? '<' : '\\leqq'} \\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}} , \\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}} ${f == 3 ? '<' : '\\leqq'} x `;
                    }
                }
            }
            function toprblemContet(numberaa, numberbb, numbercc) {
                let numbera = divideBygcb(numberaa, numberbb, numbercc, numberaa);
                let numberb = divideBygcb(numberaa, numberbb, numbercc, numberbb);
                let numberc = divideBygcb(numberaa, numberbb, numbercc, numbercc);

                if (numberb % 2 == 0) {
                    let bb = numberb / 2;
                    let rootn = tosqrt(bb * bb - numbera * numberc)[0];
                    if (numbera == 1) {
                        problemContext.x1 = `\\scriptstyle{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} } `;
                        problemContext.x2 = `${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}}  `;
                    } else {
                        problemContext.x1 = `\\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}}  `;
                        problemContext.x2 = `\\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}}  `;
                    }
                }
                else {
                    let bb = numberb;
                    let rootn = tosqrt(bb * bb - 4 * numbera * numberc)[0];
                    problemContext.x1 = `\\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}} `;
                    problemContext.x2 = `\\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}}  `;
                }
            }
            function divideBygcb(a, b, c, d) {
                const lcmValue = gcdOfThree(a, b, c);
                return d / lcmValue;
            }
            function gcdOfThree(a, b, c) {
                // ä¸‰ã¤ã®æ•°ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ã‚‹
                return gcd(gcd(a, b), c);
            }
            function tosqrt(number) {
                let ans = [];
                ans[0] = 1;
                ans[1] = number;
                for (let i = 1; i <= Math.sqrt(ans[1]); i++) {
                    if (ans[1] % (i * i) === 0) {
                        ans[0] = ans[0] * i;
                        ans[1] = ans[1] / (i * i);
                        i = 1;
                    }
                }
                return ans; // å¹³æ–¹æ•°ãŒãªã„å ´åˆ
            }
            function generateProblem() {

                let fraga = getRandomInt(1, 4);
                let a, b, c;
                do {
                    a = 1;
                    b = 2 * getRandomInt(-4, 4);
                    c = getRandomInt(-8, 8);

                } while (b * b - 4 * a * c < 0 || Math.sqrt(b * b - 4 * a * c) % 1 == 0)
                frag[0] = a;
                frag[1] = b;
                frag[2] = c;
                let fragsignal = ``;
                if (fraga == 1) {
                    fragsignal = `<`;
                    problemContext.colorFlag = 2; // frag 1 (<) -> y < 0 -> FLAG 2 (ä¸‹å´ã‚’å¼·èª¿)
                }
                else if (fraga == 2) {
                    fragsignal = `\\leqq`;
                    problemContext.colorFlag = 2; // frag 2 (<=) -> y <= 0 -> FLAG 2 (ä¸‹å´ã‚’å¼·èª¿)
                }
                else if (fraga == 3) {
                    fragsignal = `>`;
                    problemContext.colorFlag = 1; // frag 3 (>) -> y > 0 -> FLAG 1 (ä¸Šå´ã‚’å¼·èª¿)
                }
                else if (fraga == 4) {
                    fragsignal = `\\geqq`;
                    problemContext.colorFlag = 1; // frag 4 (>=) -> y >= 0 -> FLAG 1 (ä¸Šå´ã‚’å¼·èª¿)
                }
                toprblemContet(a, b, c);

                let question = `\\(${a == 1 ? '' : a}  x^2 ${b === 0 ? '' : (b > 0 ? '+' : '') + (b == 1 ? '' : b == -1 ? '-' : b) + 'x'} ${c === 0 ? '' : (c > 0 ? '+' : '-') + Math.abs(c)}${fragsignal}0\\)`;
                currentSolution = `${tosolution(a, b, c, fraga)}`;
                const result = currentSolution;
                const bAbs = Math.abs(b);
                const cAbs = Math.abs(c);
                const bDisplay = b < 0 ? `(${b})` : b;
                const cDisplay = c < 0 ? `(${c})` : c;
                const FDisplay = 4 * a * c < 0 ? `+${-4 * a * c}` : `-${4 * a * c}`;
                let printsqrt = [];
                printsqrt[0] = 1;
                printsqrt[1] = b * b - 4 * a * c;
                printsqrt = simplsqrt(printsqrt);
                midwayceremony = `$$${a == 1 ? '' : a}  x^2 ${b === 0 ? '' : (b > 0 ? '+' : '') + (b == 1 ? '' : b == -1 ? '-' : b) + 'x'} ${c === 0 ? '' : (c > 0 ? '+' : '-') + Math.abs(c)}=0$$
                ã‚’è§£ã®å…¬å¼ã§è§£ãã¨$$x=\\frac{-${bDisplay}\\pm \\sqrt{${bDisplay}^2 - 4 \\times ${a}\\times ${cDisplay}}}{2\\times ${a}}\\\\ 
                =\\frac{${-b}\\pm \\sqrt{${b * b - 4 * a * c}}}{${2 * a}}\\\\
                =\\frac{${-b}\\pm ${printfrac([printsqrt[0], printsqrt[1], 1, 1])}}{${2 * a}}\\\\
                =${-b / 2}\\pm ${printfrac([printsqrt[0], printsqrt[1], 2, 1])}$$
                <div id="graphPlaceholder"></div>`;

                const answer = `${result}`;
                // ...existing code...


                currentSolution = answer;
                const options = generateOptions(currentSolution);

                document.getElementById('problem').innerHTML = question;
                document.getElementById('solution').innerHTML = '';

                // ãƒœã‚¿ãƒ³ã¯ DOM è¦ç´ ã§ä½œã‚Šã€ã‚¯ãƒªãƒƒã‚¯æ™‚ã« checkAnswer ã‚’å‘¼ã¶ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å•é¡Œå›é¿ï¼‰
                const optionsContainer = document.getElementById('options');
                optionsContainer.innerHTML = '';
                options.forEach((option, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'option';
                    btn.innerHTML = `${index + 1}: $$${option}$$`; // MathJax è¡¨ç¤ºã‚’æƒ³å®š
                    btn.addEventListener('click', () => {
                        // checkAnswer(option, currentSolution, explanation) ã‚’ä½¿ãˆã°
                        // checkAnswer å´ã§èª¬æ˜ã‚’è¡¨ç¤ºã™ã‚‹ä»•çµ„ã¿ã«ãªã£ã¦ã„ã‚‹æƒ³å®š
                        checkAnswer(option, currentSolution, midwayceremony);
                    });
                    optionsContainer.appendChild(btn);
                });

                MathJax.Hub.Queue(['Typeset', MathJax.Hub]);


            }
            function generateOptions(correct) {
                const options = [correct];

                // è§£ã‚’æ­£è¦åŒ–ã™ã‚‹é–¢æ•°ï¼ˆé †ç•ªã«é–¢ã‚ã‚‰ãšåŒã˜å½¢ã«ã™ã‚‹ï¼‰
                function normalizeValue(value) {
                    // "x=..." ã®å½¢ã‚’æƒ³å®š
                    const match = value.match(/x=(.+)/);
                    if (!match) return value;
                    return `x=${match[1]}`;
                }

                while (options.length < 4) {
                    // æ•´æ•°ã®ç¯„å›²ã§ä¹±æ•°ã‚’ç”Ÿæˆ
                    let a, b, c;
                    let value;
                    do {
                        a = 1;
                        b = 2 * getRandomInt(-4, 4);
                        c = getRandomInt(-8, 8);
                    } while (b * b - 4 * a * c < 0 || Math.sqrt(b * b - 4 * a * c) % 1 == 0);

                    value = `${tosolution(a, b, c)}`;

                    // æ­£è¦åŒ–ã—ã¦ã‹ã‚‰é‡è¤‡ãƒã‚§ãƒƒã‚¯
                    const normalizedValue = normalizeValue(value);
                    if (!options.map(normalizeValue).includes(normalizedValue)) {
                        options.push(value);
                    }
                }

                return shuffleArray(options);
            }
        }

        function generateProblem5() {
            let frag = [];
            generateProblem();
            function tosolution(numberaa, numberbb, numbercc, f) {
                let numbera = divideBygcb(numberaa, numberbb, numbercc, numberaa);
                let numberb = divideBygcb(numberaa, numberbb, numbercc, numberbb);
                let numberc = divideBygcb(numberaa, numberbb, numbercc, numbercc);

                // å¹³æ–¹æ ¹ã®ä¿‚æ•°ãŒ 1 ã®å ´åˆã« 1 ã‚’çœç•¥ã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
                function printRootN(rootn, g) {
                    const coefficient = rootn / g;
                    // ä¿‚æ•°ãŒ 1 ã®å ´åˆã¯ç©ºæ–‡å­—åˆ—ã‚’è¿”ã—ã€1ã‚’çœç•¥ã™ã‚‹
                    // ä¿‚æ•°ãŒ -1 ã®å ´åˆã¯ãƒã‚¤ãƒŠã‚¹ç¬¦å·ã®ã¿ã‚’è¿”ã™
                    if (coefficient === 1) {
                        return '';
                    } else if (coefficient === -1) {
                        return '-';
                    }
                    // ãã‚Œä»¥å¤–ã®å ´åˆã¯ãã®ã¾ã¾ä¿‚æ•°ã‚’è¿”ã™
                    return coefficient;
                }

                if (numberb % 2 == 0) {
                    let bb = numberb / 2;
                    let rootn = tosqrt(bb * bb - numbera * numberc)[0];
                    let rootSq = tosqrt(bb * bb - numbera * numberc)[1]; // ãƒ«ãƒ¼ãƒˆã®ä¸­èº«
                    let denom = numbera;
                    // -bb ã¨ rootn ã¨ denom ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ã‚‹
                    let g = gcd(gcd(Math.abs(-bb), rootn), denom);

                    // åˆ†å­ã®å®šæ•°é …éƒ¨åˆ†ã‚’æ•´å½¢
                    const constTerm = ((-bb) / g === 0 ? '' : (-bb) / g);

                    // ä¿‚æ•°éƒ¨åˆ†ã‚’printRootNã§æ•´å½¢
                    const rootCoeff = printRootN(rootn, g);

                    // ãƒ«ãƒ¼ãƒˆã®ä¸­èº«ãŒ 1 ã®å ´åˆã¯ãƒ«ãƒ¼ãƒˆè¨˜å·å…¨ä½“ã‚’çœç•¥ã™ã‚‹
                    const rootPart = (rootSq === 1 && rootCoeff !== '') ? rootCoeff : `${rootCoeff}\\sqrt{ ${rootSq}}`;
                    // ãŸã ã—ã€rootCoeffãŒç©ºæ–‡å­—ï¼ˆã¤ã¾ã‚Šä¿‚æ•°1ï¼‰ã§rootSqãŒ1ã®å ´åˆã€å®šæ•°é …ã¨Â±ã®å¾ŒãŒç©ºã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€ãã®å ´åˆã¯1ã‚’è¡¨ç¤º
                    // ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ rootn = 0 ï¼ˆå®Ÿæ•°è§£1ã¤ï¼‰ã®å ´åˆã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã“ã§ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å°Šé‡ã—ã¾ã™
                    if (f == 1 || f == 2) {
                        if (numbera == 1) {
                            return `${constTerm}- ${rootPart}${f}`;
                        } else {
                            return `\\frac{${constTerm}- ${rootPart}}{${denom / g}} ${f == 1 ? '<' : '\\leqq'} x ${f == 1 ? '<' : '\\leqq'} \\frac{${constTerm}+ ${rootPart}}{${denom / g}}`;
                        }

                    } else {
                        if (numbera == 1) {
                            return `x ${f == 3 ? '<' : '\\leqq'} ${constTerm}- ${rootPart} , ${constTerm}+ ${rootPart} ${f == 3 ? '<' : '\\leqq'} x `;
                        } else {
                            return `x ${f == 3 ? '<' : '\\leqq'} \\frac{${constTerm}- ${rootPart}}{${denom / g}} , \\frac{${constTerm}+ ${rootPart}}{${denom / g}} ${f == 3 ? '<' : '\\leqq'} x `;
                        }

                    }

                }

                else {
                    let bb = numberb;
                    let rootn = tosqrt(bb * bb - 4 * numbera * numberc)[0];
                    let rootSq = tosqrt(bb * bb - 4 * numbera * numberc)[1]; // ãƒ«ãƒ¼ãƒˆã®ä¸­èº«
                    let denom = 2 * numbera;
                    // -bb ã¨ rootn ã¨ denom ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ã‚‹
                    let g = gcd(gcd(Math.abs(-bb), rootn), denom);

                    // ä¿‚æ•°éƒ¨åˆ†ã‚’printRootNã§æ•´å½¢
                    const rootCoeff = printRootN(rootn, g);

                    // ãƒ«ãƒ¼ãƒˆã®ä¸­èº«ãŒ 1 ã®å ´åˆã¯ãƒ«ãƒ¼ãƒˆè¨˜å·å…¨ä½“ã‚’çœç•¥ã™ã‚‹
                    const rootPart = (rootSq === 1 && rootCoeff !== '') ? rootCoeff : `${rootCoeff}\\sqrt{ ${rootSq}}`;
                    if (f == 1 || f == 2) {
                        return `\\frac{${(-bb) / g}- ${rootPart}}{${denom / g}} ${f == 1 ? '<' : '\\leqq'} x ${f == 1 ? '<' : '\\leqq'} \\frac{${(-bb) / g}+ ${rootPart}}{${denom / g}}`;
                    } else {
                        return `x ${f == 3 ? '<' : '\\leqq'} \\frac{${(-bb) / g}- ${rootPart}}{${denom / g}} , \\frac{${(-bb) / g}+ ${rootPart}}{${denom / g}} ${f == 3 ? '<' : '\\leqq'} x `;
                    }
                }
            }

            function toprblemContet(numberaa, numberbb, numbercc) {
                let numbera = divideBygcb(numberaa, numberbb, numbercc, numberaa);
                let numberb = divideBygcb(numberaa, numberbb, numbercc, numberbb);
                let numberc = divideBygcb(numberaa, numberbb, numbercc, numbercc);
                if (f == 1 || f == 2) {
                    if (numberb % 2 == 0) {
                        let bb = numberb / 2;
                        let rootn = tosqrt(bb * bb - numbera * numberc)[0];
                        if (numbera == 1) {
                            return `${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} ${f == 1 ? '<' : '\\leqq'} x ${f == 1 ? '<' : '\\leqq'} ${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}}`;
                        } else {
                            return `\\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}} ${f == 1 ? '<' : '\\leqq'} x ${f == 1 ? '<' : '\\leqq'} \\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}}`;
                        }
                    }
                    else {
                        let bb = numberb;
                        let rootn = tosqrt(bb * bb - 4 * numbera * numberc)[0];
                        return `\\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}} ${f == 1 ? '<' : '\\leqq'} x ${f == 1 ? '<' : '\\leqq'} \\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}}`;
                    }
                }
                else {
                    if (numberb % 2 == 0) {
                        let bb = numberb / 2;
                        let rootn = tosqrt(bb * bb - numbera * numberc)[0];
                        if (numbera == 1) {
                            return `x ${f == 3 ? '<' : '\\leqq'} ${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} , ${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} ${f == 3 ? '<' : '\\leqq'} x `;
                        } else {
                            return `x ${f == 3 ? '<' : '\\leqq'} \\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}} , \\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}} ${f == 3 ? '<' : '\\leqq'} x `;
                        }
                    }
                    else {
                        let bb = numberb;
                        let rootn = tosqrt(bb * bb - 4 * numbera * numberc)[0];
                        return `x ${f == 3 ? '<' : '\\leqq'} \\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}} , \\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}} ${f == 3 ? '<' : '\\leqq'} x `;
                    }
                }
            }
            function toprblemContet(numberaa, numberbb, numbercc) {
                let numbera = divideBygcb(numberaa, numberbb, numbercc, numberaa);
                let numberb = divideBygcb(numberaa, numberbb, numbercc, numberbb);
                let numberc = divideBygcb(numberaa, numberbb, numbercc, numbercc);

                if (numberb % 2 == 0) {
                    let bb = numberb / 2;
                    let rootn = tosqrt(bb * bb - numbera * numberc)[0];
                    if (numbera == 1) {
                        problemContext.x1 = `\\scriptstyle{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} } `;
                        problemContext.x2 = `${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}}  `;
                    } else {
                        problemContext.x1 = `\\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}}  `;
                        problemContext.x2 = `\\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}}  `;
                    }
                }
                else {
                    let bb = numberb;
                    let rootn = tosqrt(bb * bb - 4 * numbera * numberc)[0];
                    problemContext.x1 = `\\frac{${bb == 0 ? '' : -1 * bb}- ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}} `;
                    problemContext.x2 = `\\frac{${bb == 0 ? '' : -1 * bb}+ ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}}  `;
                }
            }

            function tomid(numberaa, numberbb, numbercc) {
                let numbera = divideBygcb(numberaa, numberbb, numbercc, numberaa);
                let numberb = divideBygcb(numberaa, numberbb, numbercc, numberbb);
                let numberc = divideBygcb(numberaa, numberbb, numbercc, numbercc);

                // å¹³æ–¹æ ¹ã®ä¿‚æ•°ãŒ 1 ã®å ´åˆã« 1 ã‚’çœç•¥ã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
                function printRootN(rootn, g) {
                    const coefficient = rootn / g;
                    // ä¿‚æ•°ãŒ 1 ã®å ´åˆã¯ç©ºæ–‡å­—åˆ—ã‚’è¿”ã—ã€1ã‚’çœç•¥ã™ã‚‹
                    // ä¿‚æ•°ãŒ -1 ã®å ´åˆã¯ãƒã‚¤ãƒŠã‚¹ç¬¦å·ã®ã¿ã‚’è¿”ã™
                    if (coefficient === 1) {
                        return '';
                    } else if (coefficient === -1) {
                        return '-';
                    }
                    // ãã‚Œä»¥å¤–ã®å ´åˆã¯ãã®ã¾ã¾ä¿‚æ•°ã‚’è¿”ã™
                    return coefficient;
                }

                if (numberb % 2 == 0) {
                    let bb = numberb / 2;
                    let rootn = tosqrt(bb * bb - numbera * numberc)[0];
                    let rootSq = tosqrt(bb * bb - numbera * numberc)[1]; // ãƒ«ãƒ¼ãƒˆã®ä¸­èº«
                    let denom = numbera;
                    // -bb ã¨ rootn ã¨ denom ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ã‚‹
                    let g = gcd(gcd(Math.abs(-bb), rootn), denom);

                    // åˆ†å­ã®å®šæ•°é …éƒ¨åˆ†ã‚’æ•´å½¢
                    const constTerm = ((-bb) / g === 0 ? '' : (-bb) / g);

                    // ä¿‚æ•°éƒ¨åˆ†ã‚’printRootNã§æ•´å½¢
                    const rootCoeff = printRootN(rootn, g);

                    // ãƒ«ãƒ¼ãƒˆã®ä¸­èº«ãŒ 1 ã®å ´åˆã¯ãƒ«ãƒ¼ãƒˆè¨˜å·å…¨ä½“ã‚’çœç•¥ã™ã‚‹
                    const rootPart = (rootSq === 1 && rootCoeff !== '') ? rootCoeff : `${rootCoeff}\\sqrt{ ${rootSq}}`;
                    // ãŸã ã—ã€rootCoeffãŒç©ºæ–‡å­—ï¼ˆã¤ã¾ã‚Šä¿‚æ•°1ï¼‰ã§rootSqãŒ1ã®å ´åˆã€å®šæ•°é …ã¨Â±ã®å¾ŒãŒç©ºã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€ãã®å ´åˆã¯1ã‚’è¡¨ç¤º
                    // ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ rootn = 0 ï¼ˆå®Ÿæ•°è§£1ã¤ï¼‰ã®å ´åˆã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã“ã§ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å°Šé‡ã—ã¾ã™

                    if (numbera == 1) {
                        return `${constTerm}\\pm ${rootPart}`;
                    } else {
                        return `\\frac{${constTerm}\\pm ${rootPart}}{${denom / g}}`;
                    }
                }
                else {
                    let bb = numberb;
                    let rootn = tosqrt(bb * bb - 4 * numbera * numberc)[0];
                    let rootSq = tosqrt(bb * bb - 4 * numbera * numberc)[1]; // ãƒ«ãƒ¼ãƒˆã®ä¸­èº«
                    let denom = 2 * numbera;
                    // -bb ã¨ rootn ã¨ denom ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ã‚‹
                    let g = gcd(gcd(Math.abs(-bb), rootn), denom);

                    // ä¿‚æ•°éƒ¨åˆ†ã‚’printRootNã§æ•´å½¢
                    const rootCoeff = printRootN(rootn, g);

                    // ãƒ«ãƒ¼ãƒˆã®ä¸­èº«ãŒ 1 ã®å ´åˆã¯ãƒ«ãƒ¼ãƒˆè¨˜å·å…¨ä½“ã‚’çœç•¥ã™ã‚‹
                    const rootPart = (rootSq === 1 && rootCoeff !== '') ? rootCoeff : `${rootCoeff}\\sqrt{ ${rootSq}}`;

                    return `\\frac{${(-bb) / g}\\pm ${rootPart}}{${denom / g}}`;
                }
            }

            function divideBygcb(a, b, c, d) {
                const lcmValue = gcdOfThree(a, b, c);
                return d / lcmValue;
            }
            function gcdOfThree(a, b, c) {
                // ä¸‰ã¤ã®æ•°ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ã‚‹
                return gcd(gcd(a, b), c);
            }
            function tosqrt(number) {
                let ans = [];
                ans[0] = 1;
                ans[1] = number;
                for (let i = 1; i <= Math.sqrt(ans[1]); i++) {
                    if (ans[1] % (i * i) === 0) {
                        ans[0] = ans[0] * i;
                        ans[1] = ans[1] / (i * i);
                        i = 1;
                    }
                }
                return ans; // å¹³æ–¹æ•°ãŒãªã„å ´åˆ
            }
            function generateProblem() {

                let fraga = getRandomInt(1, 4);
                let a, b, c;
                let midwayceremonya = ``;
                do {
                    a = getRandomInt(2, 4);
                    b = 2 * getRandomInt(-4, 4);
                    c = getRandomInt(-8, 8);

                } while (b * b - 4 * a * c < 0 || Math.sqrt(b * b - 4 * a * c) % 1 == 0)
                frag[0] = a;
                frag[1] = b;
                frag[2] = c;
                let fragsignal = ``;
                if (fraga == 1) {
                    fragsignal = `<`;
                    problemContext.colorFlag = 2; // frag 1 (<) -> y < 0 -> FLAG 2 (ä¸‹å´ã‚’å¼·èª¿)
                }
                else if (fraga == 2) {
                    fragsignal = `\\leqq`;
                    problemContext.colorFlag = 2; // frag 2 (<=) -> y <= 0 -> FLAG 2 (ä¸‹å´ã‚’å¼·èª¿)
                }
                else if (fraga == 3) {
                    fragsignal = `>`;
                    problemContext.colorFlag = 1; // frag 3 (>) -> y > 0 -> FLAG 1 (ä¸Šå´ã‚’å¼·èª¿)
                }
                else if (fraga == 4) {
                    fragsignal = `\\geqq`;
                    problemContext.colorFlag = 1; // frag 4 (>=) -> y >= 0 -> FLAG 1 (ä¸Šå´ã‚’å¼·èª¿)
                }
                toprblemContet(a, b, c);
                midwayceremonya = tomid(a, b, c);
                let question = `\\(${a == 1 ? '' : a}  x^2 ${b === 0 ? '' : (b > 0 ? '+' : '') + (b == 1 ? '' : b == -1 ? '-' : b) + 'x'} ${c === 0 ? '' : (c > 0 ? '+' : '-') + Math.abs(c)}${fragsignal}0\\)`;
                currentSolution = `${tosolution(a, b, c, fraga)}`;
                const result = currentSolution;
                const bAbs = Math.abs(b);
                const cAbs = Math.abs(c);
                const bDisplay = b < 0 ? `(${b})` : b;
                const cDisplay = c < 0 ? `(${c})` : c;
                const FDisplay = 4 * a * c < 0 ? `+${-4 * a * c}` : `-${4 * a * c}`;
                let printsqrt = [];
                printsqrt[0] = 1;
                printsqrt[1] = b * b - 4 * a * c;
                printsqrt = simplsqrt(printsqrt);
                midwayceremony = `$$${a == 1 ? '' : a}  x^2 ${b === 0 ? '' : (b > 0 ? '+' : '') + (b == 1 ? '' : b == -1 ? '-' : b) + 'x'} ${c === 0 ? '' : (c > 0 ? '+' : '-') + Math.abs(c)}=0$$
                ã‚’è§£ã®å…¬å¼ã§è§£ãã¨$$x=\\frac{-${bDisplay}\\pm \\sqrt{${bDisplay}^2 - 4 \\times ${a}\\times ${cDisplay}}}{2\\times ${a}}\\\\ 
                =\\frac{${-b}\\pm \\sqrt{${b * b - 4 * a * c}}}{${2 * a}}\\\\
                =\\frac{${-b}\\pm ${printfrac([printsqrt[0], printsqrt[1], 1, 1])}}{${2 * a}}\\\\
                =${midwayceremonya}$$
                <div id="graphPlaceholder"></div>`;

                const answer = `${result}`;
                // ...existing code...


                currentSolution = answer;
                const options = generateOptions(currentSolution);

                document.getElementById('problem').innerHTML = question;
                document.getElementById('solution').innerHTML = '';

                // ãƒœã‚¿ãƒ³ã¯ DOM è¦ç´ ã§ä½œã‚Šã€ã‚¯ãƒªãƒƒã‚¯æ™‚ã« checkAnswer ã‚’å‘¼ã¶ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å•é¡Œå›é¿ï¼‰
                const optionsContainer = document.getElementById('options');
                optionsContainer.innerHTML = '';
                options.forEach((option, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'option';
                    btn.innerHTML = `${index + 1}: $$${option}$$`; // MathJax è¡¨ç¤ºã‚’æƒ³å®š
                    btn.addEventListener('click', () => {
                        // checkAnswer(option, currentSolution, explanation) ã‚’ä½¿ãˆã°
                        // checkAnswer å´ã§èª¬æ˜ã‚’è¡¨ç¤ºã™ã‚‹ä»•çµ„ã¿ã«ãªã£ã¦ã„ã‚‹æƒ³å®š
                        checkAnswer(option, currentSolution, midwayceremony);
                    });
                    optionsContainer.appendChild(btn);
                });

                MathJax.Hub.Queue(['Typeset', MathJax.Hub]);


            }
            function generateOptions(correct) {
                const options = [correct];

                // è§£ã‚’æ­£è¦åŒ–ã™ã‚‹é–¢æ•°ï¼ˆé †ç•ªã«é–¢ã‚ã‚‰ãšåŒã˜å½¢ã«ã™ã‚‹ï¼‰
                function normalizeValue(value) {
                    // "x=..." ã®å½¢ã‚’æƒ³å®š
                    const match = value.match(/x=(.+)/);
                    if (!match) return value;
                    return `x=${match[1]}`;
                }

                while (options.length < 4) {
                    // æ•´æ•°ã®ç¯„å›²ã§ä¹±æ•°ã‚’ç”Ÿæˆ
                    let a, b, c;
                    let value;
                    do {
                        a = 1;
                        b = 2 * getRandomInt(-4, 4);
                        c = getRandomInt(-8, 8);
                    } while (b * b - 4 * a * c < 0 || Math.sqrt(b * b - 4 * a * c) % 1 == 0);

                    value = `${tosolution(a, b, c)}`;

                    // æ­£è¦åŒ–ã—ã¦ã‹ã‚‰é‡è¤‡ãƒã‚§ãƒƒã‚¯
                    const normalizedValue = normalizeValue(value);
                    if (!options.map(normalizeValue).includes(normalizedValue)) {
                        options.push(value);
                    }
                }

                return shuffleArray(options);
            }
        }

        function generateProblem6() {
            let frag = [];
            generateProblem();
            function tosolution(numberaa, numberbb, numbercc) {
                let numbera = divideBygcb(numberaa, numberbb, numbercc, numberaa);
                let numberb = divideBygcb(numberaa, numberbb, numbercc, numberbb);
                let numberc = divideBygcb(numberaa, numberbb, numbercc, numbercc);

                if (numberb % 2 == 0) {
                    let bb = numberb / 2;
                    let rootn = tosqrt(bb * bb - numbera * numberc)[0];
                    if (numbera == 1) {
                        return `${bb == 0 ? '' : -1 * bb}\\pm ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}}`;
                    } else {
                        return `\\frac{${bb == 0 ? '' : -1 * bb}\\pm ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - numbera * numberc)[1]}} }{${numbera}}`;
                    }
                }
                else {
                    let bb = numberb;
                    let rootn = tosqrt(bb * bb - 4 * numbera * numberc)[0];
                    return `\\frac{${bb == 0 ? '' : -1 * bb}\\pm ${rootn == 1 ? '' : rootn}\\sqrt{ ${tosqrt(bb * bb - 4 * numbera * numberc)[1]}}}{${2 * numbera}}`;
                }
            }
            function divideBygcb(a, b, c, d) {
                const lcmValue = gcdOfThree(a, b, c);
                return d / lcmValue;
            }
            function gcdOfThree(a, b, c) {
                // ä¸‰ã¤ã®æ•°ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ã‚‹
                return gcd(gcd(a, b), c);
            }
            function tosqrt(number) {
                let ans = [];
                ans[0] = 1;
                ans[1] = number;
                for (let i = 1; i <= Math.sqrt(ans[1]); i++) {
                    if (ans[1] % (i * i) === 0) {
                        ans[0] = ans[0] * i;
                        ans[1] = ans[1] / (i * i);
                        i = 1;
                    }
                }
                return ans; // å¹³æ–¹æ•°ãŒãªã„å ´åˆ
            }

            function areCoprime(num1, num2) {
                return gcd(num1, num2) === 1 ? 1 : 0;
            }
            function toFraction(numerator, denominator) {
                const commonDivisor = gcd(numerator, denominator);
                numerator /= commonDivisor;
                denominator /= commonDivisor;

                if (denominator < 0) { // åˆ†æ¯ãŒè² ã®å ´åˆã€ç¬¦å·ã‚’åˆ†å­ã«ç§»ã™
                    numerator *= -1;
                    denominator *= -1;
                }

                if (denominator === 1) return `${numerator}`;
                const sign = numerator < 0 ? '-' : ''; // ç¬¦å·ã‚’æ˜ç¤ºçš„ã«æ‰±ã†
                return `${sign}\\frac{${Math.abs(numerator)}}{${Math.abs(denominator)}}`;
            }

            // ã“ã“ã‹ã‚‰è¿½åŠ ï¼šåŒã˜è§£ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆåŒä¸€ãªã‚‰1ã‚’è¿”ã™ï¼‰
            function checksolution(a, b, c) {
                try {
                    const candidate = `x=${tosolution(a, b, c)}`;
                    // ç°¡æ˜“æ­£è¦åŒ–ï¼šç©ºç™½ã‚’é™¤å»ã—ã¦æ¯”è¼ƒ
                    const normalize = s => String(s).replace(/\s+/g, '');
                    if (typeof currentSolution === 'string' && normalize(candidate) === normalize(currentSolution)) {
                        return 1;
                    }
                } catch (e) {
                    // tosolution å‘¼ã³å‡ºã—ã§å•é¡ŒãŒå‡ºãŸã‚‰é‡è¤‡æ‰±ã„ã«ã—ãªã„
                }
                return 0;
            }
            function generateProblem() {
                p = getRandomInt(1, 2);
                if (p == 1) {
                    let a, b, c, d;
                    do {
                        a = getRandomInt(1, 8);
                        b = getRandomInt(1, 8);
                        c = getRandomInt(1, 8);
                        d = 1;
                    } while (b * b - 4 * a * c < 0 || Math.sqrt(b * b - 4 * a * c) % 1 == 0)
                    frag[0] = a;
                    frag[1] = b;
                    frag[2] = c;
                    let question = `\\(${a == 1 ? '' : a}  x^2 ${b === 0 ? '' : (b > 0 ? '+' : '') + (b == 1 ? '' : b == -1 ? '-' : b) + 'x'} ${c === 0 ? '' : (c > 0 ? '+' : '-') + Math.abs(c)}=0\\)`;
                    result = `x=${tosolution(a, b, c)}`;
                    const answer = `${result}`;
                    // ...existing code...


                    currentSolution = answer;
                    const options = generateOptions(currentSolution);

                    document.getElementById('problem').innerHTML = question;
                    document.getElementById('solution').innerHTML = '';

                    // ãƒœã‚¿ãƒ³ã¯ DOM è¦ç´ ã§ä½œã‚Šã€ã‚¯ãƒªãƒƒã‚¯æ™‚ã« checkAnswer ã‚’å‘¼ã¶ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å•é¡Œå›é¿ï¼‰
                    const optionsContainer = document.getElementById('options');
                    optionsContainer.innerHTML = '';
                    options.forEach((option, index) => {
                        const btn = document.createElement('button');
                        btn.className = 'option';
                        btn.innerHTML = `${index + 1}: $$${option}$$`; // MathJax è¡¨ç¤ºã‚’æƒ³å®š
                        btn.addEventListener('click', () => {
                            // checkAnswer(option, currentSolution, explanation) ã‚’ä½¿ãˆã°
                            // checkAnswer å´ã§èª¬æ˜ã‚’è¡¨ç¤ºã™ã‚‹ä»•çµ„ã¿ã«ãªã£ã¦ã„ã‚‹æƒ³å®š
                            checkAnswer(option, currentSolution, midwayceremony);
                        });
                        optionsContainer.appendChild(btn);
                    });
                    MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
                }
                else {

                    let a, b, c, d;
                    a = getRandomInt(1, 4);
                    c = getRandomInt(1, 4);
                    abtimes = a * c;
                    const g = getRandomInt(1, 2);
                    const h = getRandomInt(1, 2);
                    do {
                        if (g == 1) {
                            b = getRandomInt(1, 6);
                        } else {
                            b = getRandomInt(-6, -1);
                        }
                    } while (a != 1 && areCoprime(a, Math.abs(b)) == 0)
                    do {
                        if (h == 1) {
                            d = getRandomInt(1, 6);
                        } else {
                            d = getRandomInt(-6, -1);
                        }
                    } while (c != 1 && areCoprime(c, Math.abs(d)) == 0)

                    if (c > a) {
                        [a, c] = [c, a];
                        [b, d] = [d, b];
                    }
                    if (a == c && d > b) {
                        [b, d] = [d, b];
                    }
                    frag[0] = a * b;
                    frag[1] = b;
                    frag[2] = c * d;

                    const e = -(a * d + b * c);
                    const f = b * d;
                    let question = `\\(${a * c == 1 ? '' : a * c}  x^2 ${e === 0 ? '' : (e > 0 ? '+' : '') + (e == 1 ? '' : e == -1 ? '-' : e) + 'x'} ${f === 0 ? '' : (f > 0 ? '+' : '-') + Math.abs(f)} =0\\)`;

                    if (toFraction(b, a) == toFraction(d, c)) {
                        result = `x=${toFraction(b, a)}`;
                    } else {
                        result = `x=${toFraction(b, a)},${toFraction(d, c)}`;
                    }
                    const answer = `${result}`;
                    // ...existing code...


                    currentSolution = answer;
                    const options = generateOptions(currentSolution);

                    document.getElementById('problem').innerHTML = question;
                    document.getElementById('solution').innerHTML = '';

                    // ãƒœã‚¿ãƒ³ã¯ DOM è¦ç´ ã§ä½œã‚Šã€ã‚¯ãƒªãƒƒã‚¯æ™‚ã« checkAnswer ã‚’å‘¼ã¶ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å•é¡Œå›é¿ï¼‰
                    const optionsContainer = document.getElementById('options');
                    optionsContainer.innerHTML = '';
                    options.forEach((option, index) => {
                        const btn = document.createElement('button');
                        btn.className = 'option';
                        btn.innerHTML = `${index + 1}: $$${option}$$`; // MathJax è¡¨ç¤ºã‚’æƒ³å®š
                        btn.addEventListener('click', () => {
                            // checkAnswer(option, currentSolution, explanation) ã‚’ä½¿ãˆã°
                            // checkAnswer å´ã§èª¬æ˜ã‚’è¡¨ç¤ºã™ã‚‹ä»•çµ„ã¿ã«ãªã£ã¦ã„ã‚‹æƒ³å®š
                            checkAnswer(option, currentSolution, midwayceremony);
                        });
                        optionsContainer.appendChild(btn);
                    });
                    MathJax.Hub.Queue(["Typeset", MathJax.Hub]);

                }
            }

            function generateOptions(correct) {
                const wrongOptions = [];
                const wrongOptionssolution = [];
                let Problemk = 0;//è§£ç­”ã®è©¦è¡Œå›æ•°
                let a = 0;
                let c = 0;
                let b, d;
                for (let i = 1; i * i <= Math.abs(frag[0]); i++) {
                    if ((frag[0]) % i == 0) {
                        c = i;
                        a = frag[0] / i;
                        for (let j = 1; j * j <= Math.abs(frag[2]); j++) {
                            if ((frag[2]) % j == 0) {
                                d = j;
                                b = frag[2] / j;
                                if ((a == 1 || areCoprime(a, Math.abs(b)) == 1) && (c == 1 || areCoprime(c, Math.abs(d)) == 1)) {
                                    let wrongOption;
                                    if (toFraction(b, a) == toFraction(d, c)) {
                                        wrongOption = `x=${toFraction(b, a)}`;
                                    } else {
                                        wrongOption = `x=${toFraction(b, a)},${toFraction(d, c)}`;
                                    }
                                    if (wrongOptions.indexOf(wrongOption) === -1 && wrongOption != correct) {
                                        wrongOptions.push(wrongOption);
                                    }
                                }
                            }
                            [b, d] = [d, b];
                            if (a != c) {
                                if ((a == 1 || areCoprime(a, Math.abs(b)) == 1) && (c == 1 || areCoprime(c, Math.abs(d)) == 1)) {
                                    if (toFraction(b, a) == toFraction(d, c)) {
                                        wrongOption = `x=${toFraction(b, a)}`;
                                    } else {
                                        wrongOption = `x=${toFraction(b, a)},${toFraction(d, c)}`;
                                    }
                                    if (wrongOptions.indexOf(wrongOption) === -1 && wrongOption != correct) {
                                        wrongOptions.push(wrongOption);
                                    }
                                }
                            }
                            [b, d] = [-d, -b];
                            if ((a == 1 || areCoprime(a, Math.abs(b)) == 1) && (c == 1 || areCoprime(c, Math.abs(d)) == 1)) {
                                if (toFraction(b, a) == toFraction(d, c)) {
                                    wrongOption = `x=${toFraction(b, a)}`;
                                } else {
                                    wrongOption = `x=${toFraction(b, a)},${toFraction(d, c)}`;
                                }
                                if (wrongOptions.indexOf(wrongOption) === -1 && wrongOption != correct) {
                                    wrongOptions.push(wrongOption);
                                }
                            }
                            [b, d] = [d, b];
                            if (a != c) {
                                if ((a == 1 || areCoprime(a, Math.abs(b)) == 1) && (c == 1 || areCoprime(c, Math.abs(d)) == 1)) {
                                    if (toFraction(b, a) == toFraction(d, c)) {
                                        wrongOption = `x=${toFraction(b, a)}`;
                                    } else {
                                        wrongOption = `x=${toFraction(b, a)},${toFraction(d, c)}`;
                                    }
                                    if (wrongOptions.indexOf(wrongOption) === -1 && wrongOption != correct) {
                                        wrongOptions.push(wrongOption);
                                    }
                                }
                            }
                        }
                    }
                }
                do {
                    do {
                        a = getRandomInt(1, 8);
                        b = getRandomInt(1, 8);
                        c = getRandomInt(1, 8);
                    } while (b * b - 4 * a * c < 0 || Math.sqrt(b * b - 4 * a * c) % 1 == 0)
                } while (checksolution(a, b, c) == 1)
                wrongOptionssolution.push(`x=${tosolution(a, b, c)}`);
                do {
                    do {
                        a = getRandomInt(1, 8);
                        b = getRandomInt(1, 8);
                        c = getRandomInt(1, 8);
                    } while (b * b - 4 * a * c < 0 || Math.sqrt(b * b - 4 * a * c) % 1 == 0)
                    wrongOption = `x=${tosolution(a, b, c)}`;
                } while (checksolution(a, b, c) == 1 || wrongOptionssolution.indexOf(wrongOption) != -1)
                wrongOptionssolution.push(wrongOption);
                return shuffle(correct, wrongOptions, wrongOptionssolution);

            }

        }

        function shuffle(correct, wrongs1, wrongs2) {
            // wrongs1, wrongs2 ã‚’çµåˆã—ã¦é‡è¤‡ã‚’é™¤ãã€æ­£è§£ã‚’å«ã‚ã¦æœ€å¤§4ã¤ã®é¸æŠè‚¢ã‚’ä½œã‚‹
            const pool = [];
            if (Array.isArray(wrongs1)) pool.push(...wrongs1);
            if (Array.isArray(wrongs2)) pool.push(...wrongs2);

            // ä¸€æ„åŒ–ã—ã¦æ­£è§£ã‚’é™¤å¤–
            const uniq = Array.from(new Set(pool)).filter(x => x !== correct);

            const result = [correct];

            // ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã‚“ã§æœ€å¤§4ã¤ã«ã™ã‚‹
            while (result.length < 4 && uniq.length > 0) {
                const idx = Math.floor(Math.random() * uniq.length);
                result.push(uniq.splice(idx, 1)[0]);
            }

            // è¶³ã‚Šãªã‘ã‚Œã°ãƒ©ãƒ³ãƒ€ãƒ ãªç°¡æ˜“å€™è£œã§åŸ‹ã‚ã‚‹ï¼ˆé‡è¤‡å›é¿ï¼‰
            let attempts = 0;
            while (result.length < 4 && attempts < 100) {
                const cand = `x=${getRandomInt(-8, 8)}`;
                if (!result.includes(cand) && cand !== correct) result.push(cand);
                attempts++;
            }

            return shuffleArray(result);
        }

        function checkAnswer(selected, correct, midway) {
            const isCorrect = selected.trim() === correct.trim();

            let displayCorrect = correct;
            let displaySelected = selected;

            // ğŸ’¡ä¿®æ­£ç‚¹: Canvasã‚’ãƒ©ãƒƒãƒ—ã™ã‚‹Wrapperã¨ãƒ©ãƒ™ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ 
            const graphHTML = `
                <div style="margin-top: 20px;">
                    å›³ç¤ºã™ã‚‹ã¨æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™
                    <div id="parabolaWrapper" style="position: relative; width: ${GRAPH_WIDTH}px; height: ${GRAPH_HEIGHT}px; margin: 10px auto;">
                        <canvas id="parabolaCanvas" width="${GRAPH_WIDTH}" height="${GRAPH_HEIGHT}" style="display: block;"></canvas>
                        <div id="labelContainer">
                            </div>
                    </div>
                    <div id="intersectionPoints" style="font-size: 14px; margin-top: 5px;"></div>
                </div>
                
            `;

            // midwayceremony ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ã‚°ãƒ©ãƒ•ã«ç½®ãæ›ãˆ
            const solutionContent = midway.replace('<div id="graphPlaceholder"></div>', graphHTML);

            // solutionContent ã‚’ä½¿ã£ã¦DOMã‚’æ›´æ–°
            document.getElementById("solution").innerHTML = isCorrect
                ? `\\( ${displaySelected} \\)ã¯æ­£è§£ã§ã™ï¼<br>` + solutionContent
                : `\\( ${displaySelected} \\)ã¯ä¸æ­£è§£ã§ã™ã€‚<br>` + solutionContent + `<br>æ­£ã—ã„ç­”ãˆã¯: \\( ${displayCorrect} \\)`;

            if (isCorrect) {
                correctCount++;
            } else {
                correctCount = 0;
            }

            // ã‚°ãƒ©ãƒ•æç”»å®Ÿè¡Œ
            const { x1, x2, colorFlag } = problemContext;

            // ğŸ’¡ä¿®æ­£ç‚¹:
            // 1. drawIntersections ã‚’ã‚­ãƒ¥ãƒ¼ã«å…¥ã‚Œã€Canvasæç”»ã¨DOMãƒ©ãƒ™ãƒ«æŒ¿å…¥ã‚’è¡Œã†ã€‚
            // 2. ãã®å¾Œã« Typeset ã‚’ã‚­ãƒ¥ãƒ¼ã«å…¥ã‚Œã€æŒ¿å…¥ã•ã‚ŒãŸæ–°ã—ã„MathJaxãƒ©ãƒ™ãƒ«ã¨ã‚°ãƒ©ãƒ•ä¸‹ã®å…±æœ‰ç‚¹åº§æ¨™ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã€‚
            MathJax.Hub.Queue(function () {
                if (document.getElementById('parabolaCanvas')) {
                    drawIntersections(x1, x2, colorFlag);
                }
            }, ["Typeset", MathJax.Hub]);


            if (correctCount === 3) {
                clearInterval(timerInterval);
                endQuiz();
            } else {
                document.getElementById("options").innerHTML = '<button onclick="nextProblem()">æ¬¡ã®å•é¡Œã«é€²ã‚€</button>';
            }

            // ã“ã“ã§ã® MathJax.Hub.Queue(["Typeset", MathJax.Hub]); ã¯ã€ä¸Šè¨˜ã®ã‚­ãƒ¥ãƒ¼ã«çµ±åˆã•ã‚ŒãŸãŸã‚å‰Šé™¤

        }
        function endQuiz() {
            clearInterval(timerInterval);
            document.getElementById("quiz-screen").style.display = "none";
            document.getElementById("end-screen").style.display = "block";
            document.getElementById("elapsedTime").innerText = timeLeft;
            document.getElementById("clearedLevel").innerText = selectedLevel;
        }

        function resetQuiz(level) {
            selectedLevel = level;  // é¸æŠã•ã‚ŒãŸãƒ¬ãƒ™ãƒ«ã‚’ä¿å­˜
            correctCount = 0;
            timeLeft = 0;
            document.getElementById("end-screen").style.display = "none";
            startQuiz(level); // <-- ä¿®æ­£ï¼šå¼•æ•° level ã‚’æ¸¡ã™       
        }


        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        window.onload = () => {
            document.getElementById("start-screen").style.display = "block";
        };

    </script>
</body>

</html>
